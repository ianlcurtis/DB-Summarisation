# Azure Developer CLI (azd) configuration
# Run 'azd up' to deploy all infrastructure and applications

name: medical-mcp-server
metadata:
  template: medical-mcp-server@0.0.1

# Infrastructure configuration
infra:
  provider: bicep
  path: infra
  module: azuredeploy

# Service definitions
services:
  mcp-server:
    project: src/MedicalDbMcpServer
    language: dotnet
    host: containerapp
    docker:
      path: src/MedicalDbMcpServer/Dockerfile
      context: .
    config:
      targetPort: 8080
      env:
        - name: SqlServerConnectionString
          value: "${AZURE_SQL_SERVER_CONNECTION}"

  agent-api:
    project: src/MedicalAgent.Api
    language: dotnet
    host: containerapp
    docker:
      path: src/MedicalAgent.Api/Dockerfile
      context: .
    config:
      targetPort: 8080
      env:
        - name: OpenAi__Endpoint
          value: "${AZURE_OPENAI_ENDPOINT}"
        - name: OpenAi__DeploymentName
          value: "gpt-4o"

  web:
    project: src/MedicalAgent.Web
    language: js
    host: containerapp
    docker:
      path: Dockerfile
      context: .
    config:
      targetPort: 80

# Hooks for custom deployment steps
hooks:
  postprovision:
    shell: pwsh
    run: |
      Write-Host "=== Post-Provision: Setting up database ==="
      
      # Get current public IP for firewall rule
      Write-Host "Getting current IP address..."
      $myIp = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10)
      Write-Host "Current IP: $myIp"
      
      # Add temporary firewall rule
      Write-Host "Adding temporary firewall rule..."
      $serverName = $env:AZURE_SQL_SERVER -replace '\.database\.windows\.net$', ''
      az sql server firewall-rule create --server $serverName --resource-group $env:AZURE_RESOURCE_GROUP --name "azd-deploy-temp" --start-ip-address $myIp --end-ip-address $myIp 2>$null
      
      # Wait for firewall rule to propagate
      Start-Sleep -Seconds 5
      
      # Get SQL access token
      $token = (Get-AzAccessToken -ResourceUrl "https://database.windows.net" -AsSecureString)
      $tokenPlain = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto([System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($token.Token))
      
      # Create SQL user for MCP server managed identity
      Write-Host "Creating SQL user for MCP server..."
      try {
        Invoke-Sqlcmd -ServerInstance "$env:AZURE_SQL_SERVER" -Database "$env:AZURE_SQL_DATABASE" -AccessToken $tokenPlain -Query @"
      IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = '$env:AZURE_MCP_SERVER_APP_NAME')
      BEGIN
        CREATE USER [$env:AZURE_MCP_SERVER_APP_NAME] FROM EXTERNAL PROVIDER;
        ALTER ROLE db_datareader ADD MEMBER [$env:AZURE_MCP_SERVER_APP_NAME];
        PRINT 'Created user and granted db_datareader role';
      END
      ELSE
        PRINT 'User already exists';
      "@
        Write-Host "SQL user setup complete"
      } catch {
        Write-Host "Warning: Could not create SQL user - may already exist or no access: $_"
      }
      
      # Run database schema script
      Write-Host "Creating database schema..."
      try {
        Invoke-Sqlcmd -ServerInstance "$env:AZURE_SQL_SERVER" -Database "$env:AZURE_SQL_DATABASE" -AccessToken $tokenPlain -InputFile "db/patient_medical_history_database.sql" -ErrorAction SilentlyContinue
        Write-Host "Database schema created"
      } catch {
        Write-Host "Warning: Schema may already exist: $_"
      }
      
      # Run database data script
      Write-Host "Loading sample data..."
      try {
        Invoke-Sqlcmd -ServerInstance "$env:AZURE_SQL_SERVER" -Database "$env:AZURE_SQL_DATABASE" -AccessToken $tokenPlain -InputFile "db/patient_medical_history_data.sql" -ErrorAction SilentlyContinue
        Write-Host "Sample data loaded"
      } catch {
        Write-Host "Warning: Data may already exist: $_"
      }
      
      # Verify data
      $count = Invoke-Sqlcmd -ServerInstance "$env:AZURE_SQL_SERVER" -Database "$env:AZURE_SQL_DATABASE" -AccessToken $tokenPlain -Query "SELECT COUNT(*) AS Count FROM Patients" -ErrorAction SilentlyContinue
      Write-Host "Database contains $($count.Count) patients"
      
      # Cleanup: Remove temporary firewall rule
      Write-Host "Removing temporary firewall rule..."
      az sql server firewall-rule delete --server $serverName --resource-group $env:AZURE_RESOURCE_GROUP --name "azd-deploy-temp" --yes 2>$null
      
      Write-Host ""
      Write-Host "=== Deployment complete! ==="
      Write-Host "Web App URL: $env:AZURE_WEB_URL"
      Write-Host "Agent API URL: $env:AZURE_AGENT_API_URL"
      Write-Host "MCP Server URL: $env:AZURE_MCP_SERVER_URL"
      
      # Ensure successful exit code
      exit 0
